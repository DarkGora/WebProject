<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Архив сотрудников</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --dark-bg: #1a2035;
            --text-light: #f8f9fa;
        }

        body {
            background: var(--dark-bg);
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
        }

        .page-header {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
        }

        .employee-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .employee-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .employee-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .stats-card {
            background: var(--danger-gradient);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .action-buttons .btn {
            border-radius: 25px;
            margin: 0.2rem;
            padding: 0.5rem 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #adb5bd;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #6c757d;
        }

        .badge-deleted {
            background: var(--danger-gradient);
        }

        .search-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-light);
            border-radius: 10px;
        }

        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(102, 126, 234, 0.6);
            box-shadow: 0 0 0 0.3rem rgba(102, 126, 234, 0.25);
            color: var(--text-light);
        }

        .modal-content {
            background: var(--dark-bg);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 15px;
        }

        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
<!-- Шапка страницы -->
<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold">
                    <i class="fas fa-archive me-3"></i>Архив сотрудников
                </h1>
                <p class="lead mb-0">Управление удаленными учетными записями сотрудников</p>
            </div>
            <div class="col-md-4 text-end">
                <span class="badge bg-light text-dark fs-6">
                    <i class="fas fa-database me-2"></i>
                    Всего записей: <span th:text="${totalDeleted}">0</span>
                </span>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Уведомления -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
    </div>

    <!-- Карточка статистики -->
    <div th:if="${totalDeleted > 0}" class="stats-card">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="mb-1">
                    <i class="fas fa-trash-restore me-2"></i>
                    Найдено удаленных сотрудников
                </h4>
                <p class="mb-0">Вы можете восстановить или полностью удалить записи</p>
            </div>
            <div class="col-md-4 text-end">
                <h2 class="display-4 fw-bold mb-0" th:text="${totalDeleted}">0</h2>
            </div>
        </div>
    </div>

    <!-- Поиск и фильтры -->
    <div th:if="${totalDeleted > 0}" class="search-box">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Поиск по имени</label>
                <div class="input-group">
                    <span class="input-group-text bg-dark border-dark"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" placeholder="Введите имя сотрудника..."
                           id="searchInput" onkeyup="filterEmployees()">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Отдел</label>
                <select class="form-select" id="departmentFilter" onchange="filterEmployees()">
                    <option value="">Все отделы</option>
                    <option th:each="dept : ${departments}"
                            th:value="${dept}"
                            th:text="${dept}"></option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Должность</label>
                <select class="form-select" id="positionFilter" onchange="filterEmployees()">
                    <option value="">Все должности</option>
                    <option th:each="pos : ${positions}"
                            th:value="${pos}"
                            th:text="${pos}"></option>
                </select>
            </div>
        </div>
    </div>

    <!-- Состояние пустого архива -->
    <div th:if="${totalDeleted == 0}" class="empty-state">
        <i class="fas fa-inbox"></i>
        <h3 class="text-muted">Архив пуст</h3>
        <p class="text-muted">Нет удаленных сотрудников для отображения</p>
        <a th:href="@{/}" class="btn btn-primary mt-3">
            <i class="fas fa-arrow-left me-2"></i>Вернуться к списку сотрудников
        </a>
    </div>

    <!-- Список сотрудников -->
    <div th:if="${totalDeleted > 0}">
        <div class="row" id="employeesContainer">
            <div class="col-12" th:each="employee : ${deletedEmployees}">
                <div class="card employee-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <!-- Фото и основная информация -->
                            <div class="col-md-2 text-center">
                                <!-- ИСПРАВЛЕНО: безопасная загрузка фото -->
                                <img th:src="@{${employee.photoPath != null ? employee.photoPath : '/images/default.jpg'}}"
                                     alt="Фото сотрудника" class="employee-photo"
                                     onerror="this.src='/images/default.jpg'">
                                <div class="mt-2">
                                    <span class="badge badge-deleted text-white">
                                        <i class="fas fa-trash me-1"></i>Удален
                                    </span>
                                </div>
                            </div>

                            <!-- Информация о сотруднике -->
                            <div class="col-md-6">
                                <h5 class="card-title mb-1 text-light" th:text="${employee.name}"></h5>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-briefcase me-2"></i>
                                    <span th:text="${employee.position ?: 'Должность не указана'}"></span>
                                </p>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-building me-2"></i>
                                    <span th:text="${employee.department ?: 'Отдел не указан'}"></span>
                                </p>
                                <p class="text-muted mb-0 small" th:if="${employee.deletedAt != null}">
                                    <i class="fas fa-clock me-2"></i>
                                    Удален: <span th:text="${#temporals.format(employee.deletedAt, 'dd.MM.yyyy HH:mm')}"></span>
                                </p>
                                <p class="text-muted mb-0 small" th:if="${employee.deletedBy != null}">
                                    <i class="fas fa-user me-2"></i>
                                    Удалил: <span th:text="${employee.deletedBy}"></span>
                                </p>
                            </div>

                            <!-- Действия -->
                            <div class="col-md-4 action-buttons">
                                <!-- ИСПРАВЛЕНО: правильный путь для восстановления -->
                                <form th:action="@{/admin/restore/{id}(id=${employee.id})}" method="post" class="d-inline">
                                    <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" th:if="${_csrf != null}"/>
                                    <button type="submit" class="btn btn-success"
                                            onclick="return confirm('Восстановить сотрудника?')">
                                        <i class="fas fa-trash-restore me-2"></i>Восстановить
                                    </button>
                                </form>

                                <!-- ИСПРАВЛЕНО: правильный путь для полного удаления -->
                                <form th:action="@{/admin/permanent-delete/{id}(id=${employee.id})}" method="post" class="d-inline">
                                    <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" th:if="${_csrf != null}"/>
                                    <button type="submit" class="btn btn-danger"
                                            onclick="return confirm('ВНИМАНИЕ! Сотрудник будет полностью удален из системы. Это действие нельзя отменить. Продолжить?')">
                                        <i class="fas fa-trash-alt me-2"></i>Удалить навсегда
                                    </button>
                                </form>

                                <button type="button" class="btn btn-outline-info"
                                        data-bs-toggle="modal"
                                        th:attr="data-bs-target='#detailsModal' + ${employee.id}">
                                    <i class="fas fa-info-circle me-2"></i>Подробнее
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Модальное окно с детальной информацией -->
                <div class="modal fade" th:id="'detailsModal' + ${employee.id}" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title text-light">Детальная информация</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <img th:src="@{${employee.photoPath != null ? employee.photoPath : '/images/default.jpg'}}"
                                             alt="Фото" class="img-fluid rounded-circle mb-3" style="max-width: 150px;"
                                             onerror="this.src='/images/default.jpg'">
                                    </div>
                                    <div class="col-md-8">
                                        <h4 class="text-light" th:text="${employee.name}"></h4>
                                        <p class="text-light"><strong>Должность:</strong> <span th:text="${employee.position ?: 'Не указана'}"></span></p>
                                        <p class="text-light"><strong>Отдел:</strong> <span th:text="${employee.department ?: 'Не указан'}"></span></p>
                                        <p class="text-light" th:if="${employee.email}"><strong>Email:</strong> <span th:text="${employee.email}"></span></p>
                                        <p class="text-light" th:if="${employee.phoneNumber}"><strong>Телефон:</strong> <span th:text="${employee.phoneNumber}"></span></p>
                                        <p class="text-light" th:if="${employee.deletedAt}"><strong>Дата удаления:</strong>
                                            <span th:text="${#temporals.format(employee.deletedAt, 'dd.MM.yyyy HH:mm')}"></span></p>
                                        <p class="text-light" th:if="${employee.deletedBy}"><strong>Удалил:</strong> <span th:text="${employee.deletedBy}"></span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <form th:action="@{/admin/restore/{id}(id=${employee.id})}" method="post" class="d-inline">
                                    <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" th:if="${_csrf != null}"/>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-trash-restore me-2"></i>Восстановить
                                    </button>
                                </form>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Пагинация -->
        <div class="d-flex justify-content-between align-items-center mt-4">
            <a th:href="@{/}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Назад к списку сотрудников
            </a>

            <div class="text-muted">
                Показано <span th:text="${deletedEmployees.size()}">0</span> из <span th:text="${totalDeleted}">0</span> записей
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Фильтрация сотрудников
    function filterEmployees() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const departmentFilter = document.getElementById('departmentFilter').value.toLowerCase();
        const positionFilter = document.getElementById('positionFilter').value.toLowerCase();

        const employees = document.querySelectorAll('.employee-card');

        employees.forEach(card => {
            const name = card.querySelector('.card-title').textContent.toLowerCase();
            const department = card.querySelector('.fa-building').parentElement.textContent.toLowerCase();
            const position = card.querySelector('.fa-briefcase').parentElement.textContent.toLowerCase();

            const matchesSearch = name.includes(searchText);
            const matchesDepartment = !departmentFilter || department.includes(departmentFilter);
            const matchesPosition = !positionFilter || position.includes(positionFilter);

            if (matchesSearch && matchesDepartment && matchesPosition) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Авто-закрытие алертов через 5 секунд
    document.addEventListener('DOMContentLoaded', function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        });
    });
</script>
</body>
</html>