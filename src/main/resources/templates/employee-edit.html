<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Форма редактирования или добавления сотрудника">
    <title th:text="${employee?.id != null} ? 'Редактировать ' + ${employee?.name ?: 'сотрудника'} : 'Добавить сотрудника'">
        Редактирование сотрудника
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --dark-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success-gradient: linear-gradient(135deg, #4cd964 0%, #5ac8fa 100%);
            --warning-gradient: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            --dark-bg: #1a1d23;
            --card-bg: rgba(255, 255, 255, 0.08);
            --text-light: #f8f9fa;
            --text-muted: #adb5bd;
            --border-radius: 16px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            --transition: all 0.3s ease;
        }

        body {
            background: var(--dark-bg);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .card {
            background: var(--card-bg);
            border: none;
            border-radius: var(--border-radius);
            backdrop-filter: blur(12px);
            box-shadow: var(--box-shadow);
            animation: slideIn 0.6s ease-out;
            overflow: hidden;
        }

        .card-header {
            background: var(--primary-gradient);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 1.5rem 2rem;
            border: none;
        }

        .card-body {
            padding: 2rem;
        }

        .form-section {
            margin-bottom: 2.5rem;
            animation: fadeInUp 0.6s ease-out;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            transition: var(--transition);
        }

        .form-section:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-3px);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-icon {
            font-size: 1.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section-title {
            font-weight: 600;
            margin: 0;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-control, .form-select, .form-check-input {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-light);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: var(--transition);
        }

        .form-control:focus, .form-select:focus, .form-check-input:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            color: var(--text-light);
            transform: translateY(-2px);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-light);
        }

        .required-field::after {
            content: " *";
            color: #ff6b6b;
        }

        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-outline-secondary {
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            transition: var(--transition);
        }

        .btn-outline-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-outline-danger {
            background: var(--secondary-gradient);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .btn-outline-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(245, 87, 108, 0.5);
        }

        .photo-container {
            position: relative;
            transition: var(--transition);
            border-radius: 50%;
            padding: 5px;
            background: var(--primary-gradient);
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .photo-container img {
            width: 130px;
            height: 130px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid var(--dark-bg);
        }

        .photo-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .photo-upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .photo-upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.02);
        }

        .skills-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .skill-checkbox {
            margin-right: 0.5rem;
        }

        .skill-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .skill-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .education-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .education-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-left: 4px solid #667eea;
            transform: translateX(5px);
        }

        .education-item.invalid {
            border-left: 4px solid #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .invalid-feedback {
            color: #ff6b6b;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .form-text {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .alert {
            border-radius: 12px;
            border: none;
            padding: 1rem 1.5rem;
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.2);
            color: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .character-counter {
            font-size: 0.8rem;
            text-align: right;
            margin-top: 0.25rem;
        }

        .character-counter.near-limit {
            color: #ffc107;
        }

        .character-counter.over-limit {
            color: #dc3545;
        }

        .floating-action-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
            transition: var(--transition);
            cursor: pointer;
        }

        .floating-action-btn:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.7);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .card-body {
                padding: 1.5rem;
            }

            .form-section {
                padding: 1rem;
            }

            .photo-container {
                width: 120px;
                height: 120px;
            }

            .photo-container img {
                width: 110px;
                height: 110px;
            }

            .skills-container {
                grid-template-columns: 1fr;
            }

            .btn {
                font-size: 0.85rem;
                padding: 0.6rem 1rem;
            }
        }
    </style>
</head>
<body>
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="card shadow-lg">
                <div class="card-header text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0"
                            th:text="${employee?.id != null} ? 'Редактировать сотрудника' : 'Добавить сотрудника'">
                            Редактирование сотрудника
                        </h3>
                        <a th:href="@{/}" class="btn btn-outline-light btn-sm" aria-label="Назад">
                            <i class="bi bi-arrow-left"></i> <span>Назад</span>
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form th:action="@{/employee/save}"
                          th:object="${employee}"
                          method="post"
                          enctype="multipart/form-data"
                          id="employeeForm"
                          novalidate>
                        <input type="hidden" th:name="id" th:value="${employee?.id}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>

                        <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger animate__animated animate__fadeIn">
                            <h5><i class="bi bi-exclamation-triangle"></i> Ошибки в форме:</h5>
                            <ul class="mb-0">
                                <li th:each="error : ${#fields.errors('*')}" th:text="${error}"></li>
                            </ul>
                        </div>

                        <!-- Основная информация -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="bi bi-person-lines-fill section-icon"></i>
                                <h4 class="section-title">Основная информация</h4>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="name" class="form-label required-field">ФИО</label>
                                    <input type="text"
                                           class="form-control"
                                           id="name"
                                           th:field="*{name}"
                                           th:classappend="${#fields.hasErrors('name')} ? 'is-invalid'"
                                           required
                                           placeholder="Введите полное имя"
                                           aria-describedby="nameError">
                                    <div class="invalid-feedback" id="nameError" th:errors="*{name}"></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="phoneNumber" class="form-label">Телефон</label>
                                    <input type="tel"
                                           class="form-control"
                                           id="phoneNumber"
                                           th:field="*{phoneNumber}"
                                           th:classappend="${#fields.hasErrors('phoneNumber')} ? 'is-invalid'"
                                           pattern="\+?[0-9]{10,15}"
                                           placeholder="+375291234567"
                                           aria-describedby="phoneNumberError phoneNumberHelp">
                                    <div class="invalid-feedback" id="phoneNumberError" th:errors="*{phoneNumber}"></div>
                                    <div class="form-text" id="phoneNumberHelp">Формат: +375291234567</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="email" class="form-label required-field">Email</label>
                                    <input type="email"
                                           class="form-control"
                                           id="email"
                                           th:field="*{email}"
                                           th:classappend="${#fields.hasErrors('email')} ? 'is-invalid'"
                                           required
                                           placeholder="example@company.com"
                                           aria-describedby="emailError">
                                    <div class="invalid-feedback" id="emailError" th:errors="*{email}"></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="telegram" class="form-label">Telegram</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-dark text-light">@</span>
                                        <input type="text"
                                               class="form-control"
                                               id="telegram"
                                               th:field="*{telegram}"
                                               th:classappend="${#fields.hasErrors('telegram')} ? 'is-invalid'"
                                               placeholder="username"
                                               aria-describedby="telegramError">
                                        <div class="invalid-feedback" id="telegramError" th:errors="*{telegram}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Фото профиля -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="bi bi-camera-fill section-icon"></i>
                                <h4 class="section-title">Фото профиля</h4>
                            </div>
                            <div class="row align-items-center">
                                <div class="col-md-4 mb-3 text-center">
                                    <div class="photo-container" id="photoPreview">
                                        <div th:if="${employee?.photoPath != null}">
                                            <img th:src="${employee.photoPath}"
                                                 alt="Фото сотрудника"
                                                 class="img-fluid rounded-circle"/>
                                        </div>
                                        <div th:unless="${employee?.photoPath != null}" class="text-center text-muted">
                                            <i class="bi bi-person-square fs-1"></i>
                                            <p class="mt-2 mb-0">Нет фото</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="photo-upload-area" id="photoUploadArea">
                                        <i class="bi bi-cloud-arrow-up fs-1 text-muted mb-3"></i>
                                        <h5>Перетащите фото сюда</h5>
                                        <p class="text-muted">или</p>
                                        <label for="photo" class="btn btn-primary mb-2">
                                            <i class="bi bi-folder2-open"></i> Выберите файл
                                        </label>
                                        <input class="d-none"
                                               type="file"
                                               id="photo"
                                               name="photo"
                                               accept="image/jpeg,image/png,image/webp"
                                               aria-describedby="photoHelp"/>
                                        <div class="form-text" id="photoHelp">Максимальный размер: 5MB. Форматы: JPG, PNG, WEBP.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Навыки -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="bi bi-tools section-icon"></i>
                                <h4 class="section-title">Навыки</h4>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Выберите навыки:</label>
                                <div class="skills-container">
                                    <div th:each="skill : ${T(org.example.model.Skills).values()}"
                                         class="skill-item">
                                        <input class="form-check-input skill-checkbox"
                                               type="checkbox"
                                               th:id="${'skill_' + skill}"
                                               th:name="'skills'"
                                               th:value="${skill}"
                                               th:checked="${employee != null and employee.skills != null and employee.skills.contains(skill)}"
                                               aria-describedby="skillsError">
                                        <label class="form-check-label ms-2"
                                               th:for="${'skill_' + skill}"
                                               th:text="${skill}"></label>
                                    </div>
                                </div>
                                <div class="invalid-feedback d-block" id="skillsError" th:errors="*{skills}"></div>
                            </div>
                        </div>

                        <!-- О себе -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="bi bi-person-badge section-icon"></i>
                                <h4 class="section-title">О себе</h4>
                            </div>
                            <div class="mb-3">
                                <label for="about" class="form-label">Краткая информация</label>
                                <textarea class="form-control"
                                          id="about"
                                          th:field="*{about}"
                                          rows="3"
                                          maxlength="500"
                                          th:classappend="${#fields.hasErrors('about')} ? 'is-invalid'"
                                          placeholder="Опишите кратко о себе (например, специализация, интересы, достижения)"
                                          aria-describedby="aboutError aboutHelp"></textarea>
                                <div class="invalid-feedback" id="aboutError" th:errors="*{about}"></div>
                                <div class="form-text" id="aboutHelp">Максимум 500 символов</div>
                                <div class="character-counter" id="aboutCounter">0/500</div>
                            </div>
                        </div>

                        <!-- Профессиональная информация -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="bi bi-briefcase-fill section-icon"></i>
                                <h4 class="section-title">Профессиональная информация</h4>
                            </div>
                            <div class="mb-3">
                                <label for="resume" class="form-label">Опыт работы</label>
                                <textarea class="form-control"
                                          id="resume"
                                          th:field="*{resume}"
                                          rows="5"
                                          maxlength="2000"
                                          th:classappend="${#fields.hasErrors('resume')} ? 'is-invalid'"
                                          placeholder="Опишите ваш опыт работы, проекты, достижения"
                                          aria-describedby="resumeError resumeHelp"></textarea>
                                <div class="invalid-feedback" id="resumeError" th:errors="*{resume}"></div>
                                <div class="form-text" id="resumeHelp">Максимум 2000 символов</div>
                                <div class="character-counter" id="resumeCounter">0/2000</div>
                            </div>
                            <div class="mb-3">
                                <label for="school" class="form-label">Образование</label>
                                <textarea class="form-control"
                                          id="school"
                                          th:field="*{school}"
                                          rows="3"
                                          maxlength="1000"
                                          th:classappend="${#fields.hasErrors('school')} ? 'is-invalid'"
                                          placeholder="Укажите ваше образование, курсы, сертификаты"
                                          aria-describedby="schoolError schoolHelp"></textarea>
                                <div class="invalid-feedback" id="schoolError" th:errors="*{school}"></div>
                                <div class="form-text" id="schoolHelp">Максимум 1000 символов</div>
                                <div class="character-counter" id="schoolCounter">0/1000</div>
                            </div>
                        </div>

                        <!-- Образование (список educations) -->
                        <div class="form-section">
                            <div class="section-header">
                                <i class="bi bi-mortarboard section-icon"></i>
                                <h4 class="section-title">Образование (дополнительно)</h4>
                            </div>
                            <div id="educationsContainer">
                                <div th:each="education, iterStat : ${employee?.educations ?: new.java.util.ArrayList()}"
                                     class="education-item"
                                     th:classappend="${#fields.hasErrors('educations[' + iterStat.index + ']')} ? 'invalid' : ''">
                                    <input type="hidden" th:field="*{educations[__${iterStat.index}__].id}">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label th:for="'university_' + ${iterStat.index}" class="form-label required-field">Университет</label>
                                            <input type="text"
                                                   class="form-control"
                                                   th:id="'university_' + ${iterStat.index}"
                                                   th:field="*{educations[__${iterStat.index}__].university}"
                                                   th:classappend="${#fields.hasErrors('educations[' + iterStat.index + '].university')} ? 'is-invalid'"
                                                   required
                                                   placeholder="Название учебного заведения"
                                                   aria-describedby="'universityError_' + ${iterStat.index}">
                                            <div class="invalid-feedback"
                                                 th:id="'universityError_' + ${iterStat.index}"
                                                 th:errors="*{educations[__${iterStat.index}__].university}"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <label th:for="'degree_' + ${iterStat.index}" class="form-label required-field">Степень</label>
                                            <input type="text"
                                                   class="form-control"
                                                   th:id="'degree_' + ${iterStat.index}"
                                                   th:field="*{educations[__${iterStat.index}__].degree}"
                                                   th:classappend="${#fields.hasErrors('educations[' + iterStat.index + '].degree')} ? 'is-invalid'"
                                                   required
                                                   placeholder="Бакалавр, Магистр и т.д."
                                                   aria-describedby="'degreeError_' + ${iterStat.index}">
                                            <div class="invalid-feedback"
                                                 th:id="'degreeError_' + ${iterStat.index}"
                                                 th:errors="*{educations[__${iterStat.index}__].degree}"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <label th:for="'yearStart_' + ${iterStat.index}" class="form-label required-field">Год начала</label>
                                            <input type="number"
                                                   class="form-control"
                                                   th:id="'yearStart_' + ${iterStat.index}"
                                                   th:field="*{educations[__${iterStat.index}__].yearStart}"
                                                   th:classappend="${#fields.hasErrors('educations[' + iterStat.index + '].yearStart')} ? 'is-invalid'"
                                                   min="1900"
                                                   max="2100"
                                                   required
                                                   placeholder="2015"
                                                   aria-describedby="'yearStartError_' + ${iterStat.index}">
                                            <div class="invalid-feedback"
                                                 th:id="'yearStartError_' + ${iterStat.index}"
                                                 th:errors="*{educations[__${iterStat.index}__].yearStart}"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <label th:for="'yearEnd_' + ${iterStat.index}" class="form-label required-field">Год окончания</label>
                                            <input type="number"
                                                   class="form-control"
                                                   th:id="'yearEnd_' + ${iterStat.index}"
                                                   th:field="*{educations[__${iterStat.index}__].yearEnd}"
                                                   th:classappend="${#fields.hasErrors('educations[' + iterStat.index + '].yearEnd')} ? 'is-invalid'"
                                                   min="1900"
                                                   max="2100"
                                                   required
                                                   placeholder="2019"
                                                   aria-describedby="'yearEndError_' + ${iterStat.index}">
                                            <div class="invalid-feedback"
                                                 th:id="'yearEndError_' + ${iterStat.index}"
                                                 th:errors="*{educations[__${iterStat.index}__].yearEnd}"></div>
                                        </div>
                                        <div class="col-12 text-end">
                                            <button type="button" class="btn btn-outline-danger btn-sm" th:onclick="'removeEducation(' + ${iterStat.index} + ')'">
                                                <i class="bi bi-trash"></i> Удалить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Добавляем отображение общих ошибок для educations -->
                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('educations')}">
                                <span th:each="error : ${#fields.errors('educations')}" th:text="${error}"></span>
                            </div>
                            <button type="button" class="btn btn-outline-primary mt-3" onclick="addEducation()">
                                <i class="bi bi-plus-circle"></i> Добавить образование
                            </button>
                        </div>

                        <div class="d-flex justify-content-between mt-5 pt-3 border-top">
                            <a th:href="@{/}" class="btn btn-outline-secondary px-4" aria-label="Назад">
                                <i class="bi bi-arrow-left"></i> <span>Назад</span>
                            </a>
                            <button type="submit" class="btn btn-primary px-4"
                                    aria-label="${employee?.id != null} ? 'Сохранить изменения' : 'Добавить сотрудника'">
                                <i class="bi bi-save"></i>
                                <span th:text="${employee?.id != null} ? 'Сохранить изменения' : 'Добавить сотрудника'">Сохранить изменения</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Плавающая кнопка для быстрого возврата наверх -->
<div class="floating-action-btn" id="scrollToTop">
    <i class="bi bi-arrow-up"></i>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const photoInput = document.getElementById('photo');
        const photoPreview = document.getElementById('photoPreview');
        const photoUploadArea = document.getElementById('photoUploadArea');
        const employeeForm = document.getElementById('employeeForm');
        let educationCount = document.querySelectorAll('.education-item').length;

        console.log("Инициализация educationCount: ", educationCount);

        // Инициализация счетчиков символов
        initCharacterCounters();

        // Функция для сброса предварительного просмотра фото
        function resetPhotoPreview() {
            if (photoPreview) {
                photoPreview.innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-person-square fs-1"></i>
                    <p class="mt-2 mb-0">Нет фото</p>
                </div>`;
            }
        }

        // Обработчик для предварительного просмотра фото
        if (photoInput && photoPreview) {
            photoInput.addEventListener('change', function(e) {
                handlePhotoFile(e.target.files[0]);
            });
        }

        // Drag & Drop для фото
        if (photoUploadArea) {
            photoUploadArea.addEventListener('click', function() {
                photoInput.click();
            });

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                photoUploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                photoUploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                photoUploadArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                photoUploadArea.classList.add('dragover');
            }

            function unhighlight() {
                photoUploadArea.classList.remove('dragover');
            }

            photoUploadArea.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handlePhotoFile(files[0]);
            });
        }

        // Функция обработки файла фото
        function handlePhotoFile(file) {
            if (!file) {
                resetPhotoPreview();
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Файл слишком большой. Максимальный размер: 5MB',
                    timer: 2000,
                    showConfirmButton: false,
                    customClass: {
                        popup: 'glass-effect'
                    }
                });
                photoInput.value = '';
                resetPhotoPreview();
                return;
            }

            if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Недопустимый формат. Используйте JPG, PNG или WEBP.',
                    timer: 2000,
                    showConfirmButton: false,
                    customClass: {
                        popup: 'glass-effect'
                    }
                });
                photoInput.value = '';
                resetPhotoPreview();
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                photoPreview.innerHTML =
                    `<img src="${e.target.result}" class="img-fluid rounded-circle" alt="Предпросмотр фото">`;
            };
            reader.onerror = function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Ошибка при чтении файла.',
                    timer: 2000,
                    showConfirmButton: false,
                    customClass: {
                        popup: 'glass-effect'
                    }
                });
                resetPhotoPreview();
            };
            reader.readAsDataURL(file);
        }

        // Функция для добавления нового образования
        window.addEducation = function() {
            console.log("Кнопка нажата, добавление нового образования, индекс: ", educationCount);

            const container = document.getElementById('educationsContainer');
            if (!container) {
                console.error("Ошибка: контейнер #educationsContainer не найден");
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Не удалось найти контейнер для добавления образования.',
                    timer: 2000,
                    showConfirmButton: false,
                    customClass: {
                        popup: 'glass-effect'
                    }
                });
                return;
            }

            const newEducation = document.createElement('div');
            newEducation.className = 'education-item';
            newEducation.innerHTML = `
                <div class="row g-3">
                    <input type="hidden" name="educations[${educationCount}].id">
                    <div class="col-md-6">
                        <label for="university_${educationCount}" class="form-label required-field">Университет</label>
                        <input type="text" class="form-control" id="university_${educationCount}"
                               name="educations[${educationCount}].university" required
                               placeholder="Название учебного заведения"
                               aria-describedby="universityError_${educationCount}">
                        <div class="invalid-feedback" id="universityError_${educationCount}"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="degree_${educationCount}" class="form-label required-field">Степень</label>
                        <input type="text" class="form-control" id="degree_${educationCount}"
                               name="educations[${educationCount}].degree" required
                               placeholder="Бакалавр, Магистр и т.д."
                               aria-describedby="degreeError_${educationCount}">
                        <div class="invalid-feedback" id="degreeError_${educationCount}"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="yearStart_${educationCount}" class="form-label required-field">Год начала</label>
                        <input type="number" class="form-control" id="yearStart_${educationCount}"
                               name="educations[${educationCount}].yearStart" min="1900" max="2100" required
                               placeholder="2015"
                               aria-describedby="yearStartError_${educationCount}">
                        <div class="invalid-feedback" id="yearStartError_${educationCount}"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="yearEnd_${educationCount}" class="form-label required-field">Год окончания</label>
                        <input type="number" class="form-control" id="yearEnd_${educationCount}"
                               name="educations[${educationCount}].yearEnd" min="1900" max="2100" required
                               placeholder="2019"
                               aria-describedby="yearEndError_${educationCount}">
                        <div class="invalid-feedback" id="yearEndError_${educationCount}"></div>
                    </div>
                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.education-item').remove()">
                            <i class="bi bi-trash"></i> Удалить
                        </button>
                    </div>
                </div>
            `;

            try {
                container.appendChild(newEducation);
                educationCount++;
                console.log("Новое образование добавлено, новый индекс: ", educationCount);

                // Анимация появления нового элемента
                newEducation.style.opacity = '0';
                newEducation.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    newEducation.style.transition = 'all 0.3s ease';
                    newEducation.style.opacity = '1';
                    newEducation.style.transform = 'translateY(0)';
                }, 10);
            } catch (e) {
                console.error("Ошибка при добавлении нового образования: ", e);
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Не удалось добавить образование.',
                    timer: 2000,
                    showConfirmButton: false,
                    customClass: {
                        popup: 'glass-effect'
                    }
                });
            }
        };

        // Функция для удаления образования
        window.removeEducation = function(index) {
            console.log("Удаление образования с индексом: ", index);
            const items = document.querySelectorAll('.education-item');
            if (items[index]) {
                // Анимация удаления
                items[index].style.transform = 'translateX(-100%)';
                items[index].style.opacity = '0';
                setTimeout(() => {
                    items[index].remove();
                    console.log("Образование удалено");
                }, 300);
            } else {
                console.error("Ошибка: элемент .education-item с индексом ", index, " не найден");
            }
        };

        // Обработчик отправки формы
        if (employeeForm) {
            employeeForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Проверка валидности формы
                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');

                    // Прокрутка к первой ошибке
                    const firstInvalid = this.querySelector('.is-invalid');
                    if (firstInvalid) {
                        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }

                // Проверка годов в образовании
                let validYears = true;
                document.querySelectorAll('.education-item').forEach((item, index) => {
                    const yearStartInput = item.querySelector(`input[name="educations[${index}].yearStart"]`);
                    const yearEndInput = item.querySelector(`input[name="educations[${index}].yearEnd"]`);

                    if (yearStartInput && yearEndInput) {
                        const yearStart = parseInt(yearStartInput.value);
                        const yearEnd = parseInt(yearEndInput.value);

                        if (yearEnd && yearStart && yearEnd < yearStart) {
                            validYears = false;
                            item.classList.add('invalid');

                            Swal.fire({
                                icon: 'error',
                                title: 'Ошибка',
                                html: `Год окончания (${yearEnd}) не может быть раньше года начала (${yearStart}) в записи ${index + 1}`,
                                timer: 4000,
                                showConfirmButton: false,
                                customClass: {
                                    popup: 'glass-effect'
                                }
                            });
                        } else {
                            item.classList.remove('invalid');
                        }
                    }
                });

                if (!validYears) {
                    return;
                }

                // Подтверждение перед отправкой
                const confirmed = await confirmSubmit();
                if (confirmed) {
                    this.submit();
                }
            }, false);
        } else {
            console.error("Ошибка: форма #employeeForm не найдена");
        }

        // Функция подтверждения отправки формы
        function confirmSubmit() {
            return new Promise((resolve) => {
                const isEdit = document.querySelector('input[name="id"]').value !== '';
                Swal.fire({
                    title: isEdit ? 'Сохранить изменения?' : 'Добавить сотрудника?',
                    text: isEdit ? 'Все изменения будут сохранены.' : 'Новый сотрудник будет добавлен в систему.',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: isEdit ? 'Да, сохранить' : 'Да, добавить',
                    cancelButtonText: 'Отмена',
                    customClass: {
                        popup: 'glass-effect'
                    }
                }).then((result) => {
                    resolve(result.isConfirmed);
                });
            });
        }

        // Инициализация счетчиков символов
        function initCharacterCounters() {
            const textareas = ['about', 'resume', 'school'];

            textareas.forEach(id => {
                const textarea = document.getElementById(id);
                const counter = document.getElementById(id + 'Counter');

                if (textarea && counter) {
                    // Установить начальное значение
                    updateCounter(textarea, counter);

                    // Добавить обработчик изменения
                    textarea.addEventListener('input', function() {
                        updateCounter(this, counter);
                    });
                }
            });
        }

        // Обновление счетчика символов
        function updateCounter(textarea, counter) {
            const length = textarea.value.length;
            const maxLength = parseInt(textarea.getAttribute('maxlength'));

            counter.textContent = `${length}/${maxLength}`;

            // Изменение цвета при приближении к лимиту
            if (length > maxLength * 0.9) {
                counter.className = 'character-counter over-limit';
            } else if (length > maxLength * 0.8) {
                counter.className = 'character-counter near-limit';
            } else {
                counter.className = 'character-counter';
            }
        }

        // Кнопка возврата наверх
        document.getElementById('scrollToTop').addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Показать/скрыть кнопку возврата наверх
        window.addEventListener('scroll', () => {
            const scrollToTopBtn = document.getElementById('scrollToTop');
            if (window.scrollY > 300) {
                scrollToTopBtn.style.display = 'flex';
            } else {
                scrollToTopBtn.style.display = 'none';
            }
        });
    });
</script>
</body>
</html>