<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${employee?.id != null} ? 'Редактирование ' + ${employee.name} : 'Новый сотрудник'"></title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" th:href="@{/styles/profile.css}">

    <style>
        .card {
            border-radius: 10px;
        }
        .card-header {
            border-radius: 10px 10px 0 0;
        }
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .form-section h4 {
            color: #343a40;
            margin-bottom: 20px;
        }
        .required-field::after {
            content: '*';
            color: #dc3545;
            margin-left: 5px;
        }
        .photo-container {
            width: 120px;
            height: 120px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #dee2e6;
            border-radius: 50%;
            background-color: #fff;
        }
        .photo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .skills-container {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .category-group {
            margin-bottom: 15px;
        }
        .category-group h5 {
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 10px;
        }
        .form-check {
            margin-bottom: 5px;
        }
        .education-entry {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #fff;
        }
        .education-entry .btn-remove {
            color: #dc3545;
        }
        .alert {
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .form-section {
                padding: 15px;
            }
            .photo-container {
                width: 100px;
                height: 100px;
            }
            .education-entry .row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0" th:text="${employee?.id != null} ? 'Редактирование сотрудника' : 'Добавление нового сотрудника'"></h3>
                </div>
                <div class="card-body">
                    <!-- Сообщения об успехе или ошибке -->
                    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                        <span th:text="${successMessage}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                    </div>
                    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <span th:text="${errorMessage}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                    </div>

                    <form th:action="${employee?.id != null} ? @{'/employee/update/' + ${employee.id}} : @{/employee/save}"
                          method="post" enctype="multipart/form-data" id="employeeForm">
                        <input type="hidden" th:name="_csrf" th:value="${_csrf.token}" th:if="${_csrf}">
                        <input type="hidden" th:name="id" th:value="${employee?.id}">

                        <!-- Основная информация -->
                        <div class="form-section">
                            <h4><i class="bi bi-person-lines-fill"></i> Основная информация</h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="name" class="form-label required-field">ФИО</label>
                                    <input type="text" class="form-control" id="name" name="name"
                                           th:value="${employee?.name}" required aria-required="true">
                                </div>
                                <div class="col-md-6">
                                    <label for="phoneNumber" class="form-label">Телефон</label>
                                    <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber"
                                           th:value="${employee?.phoneNumber}" pattern="\+[0-9]{1,3}[0-9]{7,14}"
                                           aria-describedby="phoneHelp">
                                    <div id="phoneHelp" class="form-text">Формат: +7XXXXXXXXXX</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="email" class="form-label required-field">Email</label>
                                    <input type="email" class="form-control" id="email" name="email"
                                           th:value="${employee?.email}" required aria-required="true"
                                           pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$">
                                </div>
                                <div class="col-md-6">
                                    <label for="telegram" class="form-label">Telegram</label>
                                    <div class="input-group">
                                        <span class="input-group-text">@</span>
                                        <input type="text" class="form-control" id="telegram" name="telegram"
                                               th:value="${employee?.telegram}" placeholder="username"
                                               pattern="@[A-Za-z0-9_]{5,32}" aria-describedby="telegramHelp">
                                    </div>
                                    <div id="telegramHelp" class="form-text">Формат: @username</div>
                                </div>
                                <div class="col-12">
                                    <label for="category" class="form-label">Категория</label>
                                    <select class="form-select" id="category" name="category">
                                        <option value="">Выберите категорию</option>
                                        <option th:each="category : ${categories}"
                                                th:value="${category}"
                                                th:text="${category}"
                                                th:selected="${employee?.category == category}"></option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Фото профиля -->
                        <div class="form-section">
                            <h4><i class="bi bi-camera-fill"></i> Фото профиля</h4>
                            <div class="row align-items-center">
                                <div class="col-md-4 mb-3">
                                    <div class="photo-container" id="photoPreview">
                                        <div th:if="${employee?.photoPath}">
                                            <img th:src="@{${employee.photoPath}}" alt="Фото сотрудника" class="img-fluid rounded-circle">
                                        </div>
                                        <div th:unless="${employee?.photoPath}" class="text-center text-muted">
                                            <i class="bi bi-person-square fs-1"></i>
                                            <p class="mt-2 mb-0">Нет фото</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <label for="photo" class="form-label">Загрузить фото</label>
                                    <input class="form-control" type="file" id="photo" name="photo"
                                           accept="image/jpeg,image/png,image/gif" aria-describedby="photoHelp">
                                    <div id="photoHelp" class="form-text">Максимум 5MB. Форматы: JPG, PNG, GIF.</div>
                                    <input type="hidden" name="photoPath" th:value="${employee?.photoPath}">
                                </div>
                            </div>
                        </div>

                        <!-- Навыки -->
                        <div class="form-section">
                            <h4><i class="bi bi-tools"></i> Навыки</h4>
                            <div class="skills-container">
                                <div th:each="category : ${categories}" class="category-group">
                                    <h5 th:text="${category}"></h5>
                                    <div class="d-flex flex-wrap gap-3">
                                        <div th:each="skill : ${allSkills}"
                                             th:if="${skill.category == category}"
                                             class="form-check">
                                            <input class="form-check-input skill-checkbox" type="checkbox"
                                                   th:id="${'skill_' + skill.name()}"
                                                   th:value="${skill.name()}"
                                                   name="skills"
                                                   th:checked="${employee?.skills?.contains(skill) ?: false}"
                                                   aria-label="'Навык ' + ${skill}">
                                            <label class="form-check-label"
                                                   th:for="${'skill_' + skill.name()}"
                                                   th:text="${skill}"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- О себе -->
                        <div class="form-section">
                            <h4><i class="bi bi-person-badge"></i> О себе</h4>
                            <div class="mb-3">
                                <label for="skill" class="form-label">Краткая информация</label>
                                <textarea class="form-control" id="skill" name="skill"
                                          rows="3" placeholder="Расскажите о себе" maxlength="500"
                                          th:text="${employee?.skill}" aria-describedby="skillHelp"></textarea>
                                <div id="skillHelp" class="form-text">Максимум 500 символов</div>
                            </div>
                        </div>

                        <!-- Образование -->
                        <div class="form-section">
                            <h4><i class="bi bi-mortarboard-fill"></i> Образование</h4>
                            <div id="educationContainer">
                                <div th:each="edu, iterStat : ${educations}" class="education-entry">
                                    <input type="hidden" th:name="'educations[' + ${iterStat.index} + '].id'"
                                           th:value="${edu.id}">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label th:for="'university_' + ${iterStat.index}" class="form-label required-field">Учебное заведение</label>
                                            <input type="text" class="form-control"
                                                   th:id="'university_' + ${iterStat.index}"
                                                   th:name="'educations[' + ${iterStat.index} + '].university'"
                                                   th:value="${edu.university}" required aria-required="true">
                                        </div>
                                        <div class="col-md-3">
                                            <label th:for="'yearStart_' + ${iterStat.index}" class="form-label required-field">Год начала</label>
                                            <input type="number" class="form-control"
                                                   th:id="'yearStart_' + ${iterStat.index}"
                                                   th:name="'educations[' + ${iterStat.index} + '].yearStart'"
                                                   th:value="${edu.yearStart}" required aria-required="true"
                                                   min="1900" max="2100">
                                        </div>
                                        <div class="col-md-3">
                                            <label th:for="'yearEnd_' + ${iterStat.index}" class="form-label required-field">Год окончания</label>
                                            <input type="number" class="form-control"
                                                   th:id="'yearEnd_' + ${iterStat.index}"
                                                   th:name="'educations[' + ${iterStat.index} + '].yearEnd'"
                                                   th:value="${edu.yearEnd}" required aria-required="true"
                                                   min="1900" max="2100">
                                        </div>
                                        <div class="col-12">
                                            <label th:for="'degree_' + ${iterStat.index}" class="form-label required-field">Степень/квалификация</label>
                                            <input type="text" class="form-control"
                                                   th:id="'degree_' + ${iterStat.index}"
                                                   th:name="'educations[' + ${iterStat.index} + '].degree'"
                                                   th:value="${edu.degree}" required aria-required="true">
                                        </div>
                                        <div class="col-12 text-end">
                                            <button type="button" class="btn btn-link btn-remove"
                                                    onclick="removeEducation(this)"
                                                    aria-label="Удалить запись об образовании">
                                                <i class="bi bi-trash"></i> Удалить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary mt-2"
                                    onclick="addEducation()"
                                    aria-label="Добавить новую запись об образовании">
                                <i class="bi bi-plus-circle"></i> Добавить образование
                            </button>
                        </div>

                        <!-- Профессиональная информация -->
                        <div class="form-section">
                            <h4><i class="bi bi-briefcase-fill"></i> Опыт работы</h4>
                            <div class="mb-3">
                                <label for="resume" class="form-label">Опыт работы</label>
                                <textarea class="form-control" id="resume" name="resume"
                                          rows="5" placeholder="Опишите ваш профессиональный опыт" maxlength="2000"
                                          th:text="${employee?.resume}" aria-describedby="resumeHelp"></textarea>
                                <div id="resumeHelp" class="form-text">Максимум 2000 символов</div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a th:href="@{/}" class="btn btn-outline-secondary" aria-label="Вернуться к списку сотрудников">
                                <i class="bi bi-arrow-left"></i> Назад
                            </a>
                            <button type="submit" class="btn btn-primary px-4" aria-label="Сохранить изменения сотрудника">
                                <i class="bi bi-save"></i>
                                <span th:text="${employee?.id != null} ? 'Сохранить изменения' : 'Добавить сотрудника'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Предпросмотр фото
        const photoInput = document.getElementById('photo');
        const photoPreview = document.getElementById('photoPreview');
        photoInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                // Проверка размера и типа файла
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Ошибка',
                        text: 'Файл слишком большой. Максимальный размер: 5MB'
                    });
                    photoInput.value = '';
                    return;
                }
                if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Ошибка',
                        text: 'Недопустимый формат. Разрешены: JPG, PNG, GIF'
                    });
                    photoInput.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function (e) {
                    photoPreview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded-circle" alt="Предпросмотр фото">`;
                };
                reader.readAsDataURL(file);
            } else {
                photoPreview.innerHTML = `<div class="text-center text-muted"><i class="bi bi-person-square fs-1"></i><p class="mt-2 mb-0">Нет фото</p></div>`;
            }
        });

        // Проверка уникальности email
        const emailInput = document.getElementById('email');
        emailInput.addEventListener('blur', function () {
            const email = this.value.trim();
            if (email) {
                fetch('/employee/check-email?email=' + encodeURIComponent(email), {
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Ошибка',
                                text: 'Этот email уже используется'
                            });
                            emailInput.setCustomValidity('Email уже существует');
                        } else {
                            emailInput.setCustomValidity('');
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ошибка',
                            text: 'Не удалось проверить email: ' + error.message
                        });
                    });
            }
        });

        // Валидация формы перед отправкой
        document.getElementById('employeeForm').addEventListener('submit', function (e) {
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phoneNumber');
            const telegramInput = document.getElementById('telegram');

            if (!nameInput.value.trim()) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Поле "ФИО" обязательно для заполнения'
                });
                nameInput.focus();
                return;
            }

            if (!emailInput.value.trim()) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Поле "Email" обязательно для заполнения'
                });
                emailInput.focus();
                return;
            }

            if (phoneInput.value && !phoneInput.checkValidity()) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Неверный формат телефона. Пример: +79991234567'
                });
                phoneInput.focus();
                return;
            }

            if (telegramInput.value && !telegramInput.checkValidity()) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Неверный формат Telegram. Пример: @username'
                });
                telegramInput.focus();
                return;
            }
        });

        // Динамическое добавление образования
        let educationIndex = document.querySelectorAll('.education-entry').length;
        window.addEducation = function () {
            const container = document.getElementById('educationContainer');
            const entry = document.createElement('div');
            entry.className = 'education-entry';
            entry.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="university_${educationIndex}" class="form-label required-field">Учебное заведение</label>
                        <input type="text" class="form-control" id="university_${educationIndex}"
                               name="educations[${educationIndex}].university" required aria-required="true">
                    </div>
                    <div class="col-md-3">
                        <label for="yearStart_${educationIndex}" class="form-label required-field">Год начала</label>
                        <input type="number" class="form-control" id="yearStart_${educationIndex}"
                               name="educations[${educationIndex}].yearStart" required aria-required="true"
                               min="1900" max="2100">
                    </div>
                    <div class="col-md-3">
                        <label for="yearEnd_${educationIndex}" class="form-label required-field">Год окончания</label>
                        <input type="number" class="form-control" id="yearEnd_${educationIndex}"
                               name="educations[${educationIndex}].yearEnd" required aria-required="true"
                               min="1900" max="2100">
                    </div>
                    <div class="col-12">
                        <label for="degree_${educationIndex}" class="form-label required-field">Степень/квалификация</label>
                        <input type="text" class="form-control" id="degree_${educationIndex}"
                               name="educations[${educationIndex}].degree" required aria-required="true">
                    </div>
                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-link btn-remove" onclick="removeEducation(this)"
                                aria-label="Удалить запись об образовании">
                            <i class="bi bi-trash"></i> Удалить
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(entry);
            educationIndex++;
        };

        // Удаление записи об образовании
        window.removeEducation = function (button) {
            button.closest('.education-entry').remove();
        };
    });
</script>
</body>
</html>