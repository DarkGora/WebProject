<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Форма редактирования или добавления сотрудника">
    <title th:text="${employee?.id != null} ? 'Редактировать ' + ${employee?.name ?: 'сотрудника'} : 'Добавить сотрудника'">
        Редактирование сотрудника
    </title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/styles/profile.css}">
    <style>
        .invalid-feedback {
            display: none;
        }
        .is-invalid ~ .invalid-feedback {
            display: block;
        }
        .required-field::after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>
<div class="123">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"
                        th:text="${employee?.id != null} ? 'Редактировать сотрудника' : 'Добавить сотрудника'">
                        Редактирование сотрудника
                    </h3>
                </div>
                <div class="card-body">
                    <form th:action="@{/employee/save}"
                          th:object="${employee}"
                          method="post"
                          enctype="multipart/form-data"
                          id="employeeForm">
                        <input type="hidden" th:name="id" th:value="${employee?.id}">

                        <!-- Глобальные ошибки формы -->
                        <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger">
                            <span th:each="error : ${#fields.errors('*')}" th:text="${error}"></span>
                        </div>
                        <!-- Основная информация -->
                        <div class="form-section">
                            <h4 class="mb-4"><i class="bi bi-person-lines-fill"></i> <span>Основная информация</span></h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="name" class="form-label required-field">ФИО</label>
                                    <input type="text"
                                           class="form-control"
                                           id="name"
                                           th:field="*{name}"
                                           th:classappend="${#fields.hasErrors('name')} ? 'is-invalid'"
                                           required
                                           aria-describedby="nameError">
                                    <div class="invalid-feedback" id="nameError" th:errors="*{name}"></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="phoneNumber" class="form-label">Телефон</label>
                                    <input type="tel"
                                           class="form-control"
                                           id="phoneNumber"
                                           th:field="*{phoneNumber}"
                                           th:classappend="${#fields.hasErrors('phoneNumber')} ? 'is-invalid'"
                                           pattern="\+?[0-9]{10,15}"
                                           aria-describedby="phoneNumberError phoneNumberHelp">
                                    <div class="invalid-feedback" id="phoneNumberError" th:errors="*{phoneNumber}"></div>
                                    <div class="form-text" id="phoneNumberHelp">Формат: +375291234567</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="email" class="form-label required-field">Email</label>
                                    <input type="email"
                                           class="form-control"
                                           id="email"
                                           th:field="*{email}"
                                           th:classappend="${#fields.hasErrors('email')} ? 'is-invalid'"
                                           required
                                           aria-describedby="emailError">
                                    <div class="invalid-feedback" id="emailError" th:errors="*{email}"></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="telegram" class="form-label">Telegram</label>
                                    <div class="input-group">
                                        <span class="input-group-text">@</span>
                                        <input type="text"
                                               class="form-control"
                                               id="telegram"
                                               th:field="*{telegram}"
                                               th:classappend="${#fields.hasErrors('telegram')} ? 'is-invalid'"
                                               placeholder="username"
                                               aria-describedby="telegramError">
                                        <div class="invalid-feedback" id="telegramError" th:errors="*{telegram}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Фото профиля -->
                        <div class="form-section">
                            <h4 class="mb-4"><i class="bi bi-camera-fill"></i> <span>Фото профиля</span></h4>
                            <div class="row align-items-center">
                                <div class="col-md-4 mb-3">
                                    <div class="photo-container" id="photoPreview">
                                        <div th:if="${employee.photoPath != null}">
                                            <img th:src="${employee.photoPath}"
                                                 alt="Фото сотрудника"
                                                 class="img-fluid rounded-circle"/>
                                        </div>
                                        <div th:unless="${employee.photoPath != null}" class="text-center text-muted">
                                            <i class="bi bi-person-square fs-1"></i>
                                            <p class="mt-2 mb-0">Нет фото</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <label for="photo" class="form-label">Загрузить фото</label>
                                    <input class="form-control"
                                           type="file"
                                           id="photo"
                                           name="photo"
                                           accept="image/jpeg,image/png,image/webp"
                                           aria-describedby="photoHelp"/>
                                    <div class="form-text" id="photoHelp">Максимальный размер: 5MB. Форматы: JPG, PNG, WEBP.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Навыки -->
                        <div class="form-section">
                            <h4 class="mb-4"><i class="bi bi-tools"></i> <span>Навыки</span></h4>
                            <div class="mb-3">
                                <label class="form-label">Выберите навыки:</label>
                                <div class="d-flex flex-wrap gap-3">
                                    <div th:each="skill : ${T(org.example.model.Skills).values()}"
                                         class="form-check">
                                        <input class="form-check-input skill-checkbox"
                                               type="checkbox"
                                               th:id="${'skill_' + skill}"
                                               th:name="'skills'"
                                               th:value="${skill}"
                                               th:checked="${employee != null and employee.skills != null and employee.skills.contains(skill)}"
                                               aria-describedby="skillsError">
                                        <label class="form-check-label"
                                               th:for="${'skill_' + skill}"
                                               th:text="${skill}"></label>
                                    </div>
                                </div>
                                <div class="invalid-feedback d-block" id="skillsError" th:errors="*{skills}"></div>
                            </div>
                        </div>

                        <!-- О себе -->
                        <div class="form-section">
                            <h4 class="mb-4"><i class="bi bi-person-badge"></i> <span>О себе</span></h4>
                            <div class="mb-3">
                                <label for="about" class="form-label">Краткая информация</label>
                                <textarea class="form-control"
                                          id="about"
                                          th:field="*{about}"
                                          rows="3"
                                          maxlength="500"
                                          th:classappend="${#fields.hasErrors('about')} ? 'is-invalid'"
                                          placeholder="Опишите кратко о себе (например, специализация)"
                                          aria-describedby="aboutError aboutHelp"></textarea>
                                <div class="invalid-feedback" id="aboutError" th:errors="*{about}"></div>
                                <div class="form-text" id="aboutHelp">Максимум 500 символов</div>
                            </div>
                        </div>

                        <!-- Профессиональная информация -->
                        <div class="form-section">
                            <h4 class="mb-4"><i class="bi bi-briefcase-fill"></i> <span>Профессиональная информация</span></h4>
                            <div class="mb-3">
                                <label for="resume" class="form-label">Опыт работы</label>
                                <textarea class="form-control"
                                          id="resume"
                                          th:field="*{resume}"
                                          rows="5"
                                          maxlength="2000"
                                          th:classappend="${#fields.hasErrors('resume')} ? 'is-invalid'"
                                          placeholder="Опишите ваш опыт работы"
                                          aria-describedby="resumeError resumeHelp"></textarea>
                                <div class="invalid-feedback" id="resumeError" th:errors="*{resume}"></div>
                                <div class="form-text" id="resumeHelp">Максимум 2000 символов</div>
                            </div>
                            <div class="mb-3">
                                <label for="school" class="form-label">Образование</label>
                                <textarea class="form-control"
                                          id="school"
                                          th:field="*{school}"
                                          rows="3"
                                          maxlength="1000"
                                          th:classappend="${#fields.hasErrors('school')} ? 'is-invalid'"
                                          placeholder="Укажите ваше образование"
                                          aria-describedby="schoolError schoolHelp"></textarea>
                                <div class="invalid-feedback" id="schoolError" th:errors="*{school}"></div>
                                <div class="form-text" id="schoolHelp">Максимум 1000 символов</div>
                            </div>
                        </div>

                        <!-- Образование (список educations) -->
                        <div class="form-section">
                            <h4 class="mb-4"><i class="bi bi-mortarboard"></i> <span>Образование (дополнительно)</span></h4>
                            <div th:each="education, iterStat : ${employee?.educations ?: new java.util.ArrayList()}"
                                 class="mb-3 education-item"
                                 th:classappend="${#fields.hasErrors('educations[' + iterStat.index + ']')} ? 'border border-danger rounded p-2'">
                                <input type="hidden" th:field="*{educations[__${iterStat.index}__].id}">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label th:for="'university_' + ${iterStat.index}" class="form-label required-field">Университет</label>
                                        <input type="text"
                                               class="form-control"
                                               th:id="'university_' + ${iterStat.index}"
                                               th:field="*{educations[__${iterStat.index}__].university}"
                                               th:classappend="${#fields.hasErrors('educations[' + iterStat.index + '].university')} ? 'is-invalid'"
                                               required
                                               aria-describedby="'universityError_' + ${iterStat.index}">
                                        <div class="invalid-feedback"
                                             th:id="'universityError_' + ${iterStat.index}"
                                             th:errors="*{educations[__${iterStat.index}__].university}"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label th:for="'degree_' + ${iterStat.index}" class="form-label required-field">Степень</label>
                                        <input type="text"
                                               class="form-control"
                                               th:id="'degree_' + ${iterStat.index}"
                                               th:field="*{educations[__${iterStat.index}__].degree}"
                                               th:classappend="${#fields.hasErrors('educations[' + iterStat.index + '].degree')} ? 'is-invalid'"
                                               required
                                               aria-describedby="'degreeError_' + ${iterStat.index}">
                                        <div class="invalid-feedback"
                                             th:id="'degreeError_' + ${iterStat.index}"
                                             th:errors="*{educations[__${iterStat.index}__].degree}"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label th:for="'yearStart_' + ${iterStat.index}" class="form-label required-field">Год начала</label>
                                        <input type="number"
                                               class="form-control"
                                               th:id="'yearStart_' + ${iterStat.index}"
                                               th:field="*{educations[__${iterStat.index}__].yearStart}"
                                               th:classappend="${#fields.hasErrors('educations[' + iterStat.index + '].yearStart')} ? 'is-invalid'"
                                               min="1900"
                                               max="2100"
                                               required
                                               aria-describedby="'yearStartError_' + ${iterStat.index}">
                                        <div class="invalid-feedback"
                                             th:id="'yearStartError_' + ${iterStat.index}"
                                             th:errors="*{educations[__${iterStat.index}__].yearStart}"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label th:for="'yearEnd_' + ${iterStat.index}" class="form-label required-field">Год окончания</label>
                                        <input type="number"
                                               class="form-control"
                                               th:id="'yearEnd_' + ${iterStat.index}"
                                               th:field="*{educations[__${iterStat.index}__].yearEnd}"
                                               th:classappend="${#fields.hasErrors('educations[' + iterStat.index + '].yearEnd')} ? 'is-invalid'"
                                               min="1900"
                                               max="2100"
                                               required
                                               aria-describedby="'yearEndError_' + ${iterStat.index}">
                                        <div class="invalid-feedback"
                                             th:id="'yearEndError_' + ${iterStat.index}"
                                             th:errors="*{educations[__${iterStat.index}__].yearEnd}"></div>
                                    </div>
                                    <div class="col-12">
                                        <button type="button" class="btn btn-outline-danger btn-sm" th:onclick="'removeEducation(' + ${iterStat.index} + ')'">Удалить</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary mt-2" onclick="addEducation()">Добавить образование</button>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a th:href="@{/}" class="btn btn-outline-secondary" aria-label="Назад">
                                <i class="bi bi-arrow-left"></i> <span>Назад</span>
                            </a>
                            <form method="POST" action="/your-endpoint">
                                <button type="submit" class="btn btn-primary px-4"
                                        aria-label="${employee?.id != null} ? 'Сохранить изменения' : 'Добавить сотрудника'"
                                        onclick="return confirmAdd()">
                                    <i class="bi bi-save"></i>
                                    <span th:text="${employee?.id != null} ? 'Сохранить изменения' : 'Добавить сотрудника'">Сохранить изменения</span>
                                </button>
                            </form>
                            <script src="/JS/Script.js?v=1"></script>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Предпросмотр фото перед загрузкой
    document.addEventListener('DOMContentLoaded', function() {
        const photoInput = document.getElementById('photo');
        const photoPreview = document.getElementById('photoPreview');
        const employeeForm = document.getElementById('employeeForm');

        function resetPhotoPreview() {
            if (photoPreview) {
                photoPreview.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-person-square fs-1"></i>
                        <p class="mt-2 mb-0">Нет фото</p>
                    </div>`;
            }
        }

        if (photoInput && photoPreview) {
            photoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) {
                    resetPhotoPreview();
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    alert('Файл слишком большой. Максимальный размер: 5MB');
                    e.target.value = '';
                    resetPhotoPreview();
                    return;
                }

                if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                    alert('Недопустимый формат. Используйте JPG, PNG или WEBP.');
                    e.target.value = '';
                    resetPhotoPreview();
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.innerHTML =
                        `<img src="${e.target.result}" class="img-fluid rounded-circle" alt="Предпросмотр фото">`;
                };
                reader.onerror = function() {
                    alert('Ошибка при чтении файла.');
                    resetPhotoPreview();
                };
                reader.readAsDataURL(file);
            });

            // Инициализация превью при загрузке страницы
            resetPhotoPreview();
        }

        // Динамическое добавление полей для образования
        let educationCount = 0; // Будет инициализировано из Thymeleaf или 0 по умолчанию
        if (typeof employeeEducationsCount !== 'undefined') {
            educationCount = employeeEducationsCount;
        }

        window.addEducation = function() {
            const container = document.createElement('div');
            container.className = 'mb-3 education-item';
            container.innerHTML = `
                <div class="row g-3">
                    <input type="hidden" name="educations[${educationCount}].id">
                    <div class="col-md-6">
                        <label for="university_${educationCount}" class="form-label required-field">Университет</label>
                        <input type="text" class="form-control" id="university_${educationCount}"
                               name="educations[${educationCount}].university" required
                               aria-describedby="universityError_${educationCount}">
                        <div class="invalid-feedback" id="universityError_${educationCount}"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="degree_${educationCount}" class="form-label required-field">Степень</label>
                        <input type="text" class="form-control" id="degree_${educationCount}"
                               name="educations[${educationCount}].degree" required
                               aria-describedby="degreeError_${educationCount}">
                        <div class="invalid-feedback" id="degreeError_${educationCount}"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="yearStart_${educationCount}" class="form-label required-field">Год начала</label>
                        <input type="number" class="form-control" id="yearStart_${educationCount}"
                               name="educations[${educationCount}].yearStart" min="1900" max="2100" required
                               aria-describedby="yearStartError_${educationCount}">
                        <div class="invalid-feedback" id="yearStartError_${educationCount}"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="yearEnd_${educationCount}" class="form-label required-field">Год окончания</label>
                        <input type="number" class="form-control" id="yearEnd_${educationCount}"
                               name="educations[${educationCount}].yearEnd" min="1900" max="2100" required
                               aria-describedby="yearEndError_${educationCount}">
                        <div class="invalid-feedback" id="yearEndError_${educationCount}"></div>
                    </div>
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.education-item').remove()">Удалить</button>
                    </div>
                </div>
            `;
            const formSection = document.querySelector('.form-section:last-of-type');
            if (formSection) {
                const addButton = formSection.querySelector('.btn-outline-primary');
                if (addButton) {
                    formSection.insertBefore(container, addButton);
                    educationCount++;
                }
            }
        };

        // Удаление поля образования (теперь используется closest() в кнопке удаления)
        window.removeEducation = function(index) {
            const item = document.querySelector(`.education-item:nth-child(${index + 1})`);
            if (item) item.remove();
        };

        // Валидация формы перед отправкой
        if (employeeForm) {
            employeeForm.addEventListener('submit', function(e) {
                if (!this.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                this.classList.add('was-validated');
            }, false);
        }
    });
</script>
</body>
</html>