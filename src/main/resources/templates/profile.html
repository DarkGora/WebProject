<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkGora | Мой профиль</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --dark-bg: #1a2035;
            --darker-bg: #121726;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-light: #f8f9fa;
            --text-muted: #adb5bd;
            --border-radius: 16px;
        }

        body {
            background: var(--dark-bg);
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .profile-header {
            background: var(--primary-gradient);
            border-radius: var(--border-radius);
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .stats-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .nav-tabs .nav-link {
            color: var(--text-muted);
            border: none;
            padding: 1rem 1.5rem;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            color: var(--text-light);
            background: rgba(102, 126, 234, 0.2);
            border: none;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 253, 253, 0.15);
            color: var(--text-light);
            border-radius: 10px;
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(102, 126, 234, 0.6);
            box-shadow: 0 0 0 0.3rem rgba(102, 126, 234, 0.25);
            color: var(--text-light);
        }
    </style>
</head>
<body>
<!-- Навигация -->
<nav class="navbar navbar-expand-lg navbar-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" th:href="@{/}">
            <i class="bi bi-people-fill me-2"></i>
            <span>DarkGora</span>
        </a>
        <div class="d-flex align-items-center">
            <a th:href="@{/}" class="btn btn-outline-light me-2">
                <i class="bi bi-arrow-left me-2"></i>Назад
            </a>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <!-- Уведомления -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
    </div>

    <!-- Отладочная информация -->
    <div class="alert alert-info" th:if="${employee == null}">
        <i class="bi bi-info-circle me-2"></i>
        Объект employee не найден в модели
    </div>

    <!-- Заголовок профиля -->
    <div class="profile-header animate__animated animate__fadeIn">
        <div class="row align-items-center position-relative">
            <div class="col-auto">
                <img th:src="@{${employee?.photoPath != null ? employee.photoPath : '/images/default.jpg'}}"
                     class="profile-avatar rounded-circle"
                     alt="Аватар"
                     onerror="this.src='/images/default.jpg'">
            </div>
            <div class="col">
                <h1 class="mb-1" th:text="${employee?.name} ?: 'Пользователь'">Имя не указано</h1>
                <p class="mb-0 opacity-75">
                    <i class="bi bi-person-badge me-1"></i>
                    <span th:text="${employee?.position} ?: 'Должность не указана'">Должность не указана</span>
                </p>
            </div>
            <div class="col-auto">
                <!-- ИСПРАВЛЕНО: статус в зависимости от employee.active -->
                <span th:if="${employee?.active}" class="badge bg-success fs-6">
                    <i class="bi bi-shield-check me-1"></i>
                    Активный
                </span>
                <span th:unless="${employee?.active}" class="badge bg-secondary fs-6">
                    <i class="bi bi-shield-x me-1"></i>
                    Неактивен
                </span>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Боковая панель -->
        <div class="col-lg-3 mb-4">
            <div class="stats-card">
                <div class="text-center mb-4">
                    <div class="mb-3">
                        <i class="bi bi-person-circle fs-1 text-primary"></i>
                    </div>
                    <h5>Профиль пользователя</h5>
                    <p class="text-muted small">Управление вашими данными</p>
                </div>

                <div class="nav flex-column nav-pills">
                    <a class="nav-link active" href="#personal" data-bs-toggle="tab">
                        <i class="bi bi-person me-2"></i>Личные данные
                    </a>
                    <a class="nav-link" href="#activity" data-bs-toggle="tab">
                        <i class="bi bi-graph-up me-2"></i>Активность
                    </a>
                    <a class="nav-link" th:href="@{/settings}">
                        <i class="bi bi-gear me-2"></i>Настройки
                    </a>
                </div>
            </div>

            <!-- Статистика -->
            <div class="stats-card mt-3">
                <h6 class="mb-3"><i class="bi bi-bar-chart me-2"></i>Статистика</h6>
                <div class="d-flex justify-content-between mb-2">
                    <span>В системе:</span>
                    <span class="text-success">1+ год</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Последний вход:</span>
                    <span>Сегодня</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Роль:</span>
                    <span class="badge bg-primary" sec:authentication="principal.authorities"></span>
                </div>
            </div>
        </div>

        <!-- Основное содержимое -->
        <div class="col-lg-9">
            <div class="tab-content">
                <!-- Личные данные -->
                <div class="tab-pane fade show active" id="personal">
                    <div class="stats-card">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4><i class="bi bi-person-lines-fill me-2"></i>Личные данные</h4>
                            <button class="btn btn-outline-primary" id="editProfileBtn">
                                <i class="bi bi-pencil me-1"></i>Редактировать
                            </button>
                        </div>

                        <form th:action="@{/profile/update}" method="post" id="profileForm">
                            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" th:if="${_csrf != null}"/>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Имя пользователя</label>
                                    <input type="text" class="form-control" th:value="${employee?.name}" readonly>
                                    <div class="form-text">Имя пользователя нельзя изменить</div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" th:value="${employee?.email}" readonly>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Полное имя</label>
                                    <input type="text" class="form-control" name="displayName"
                                           th:value="${employee?.name}" id="displayName" readonly>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Телефон</label>
                                    <input type="tel" class="form-control" name="phoneNumber"
                                           th:value="${employee?.phoneNumber}"
                                           placeholder="+7 XXX XXX XX XX" id="phoneNumber" readonly>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Отдел</label>
                                    <input type="text" class="form-control" name="department"
                                           th:value="${employee?.department}"
                                           placeholder="Ваш отдел" id="department" readonly>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Должность</label>
                                    <input type="text" class="form-control" name="position"
                                           th:value="${employee?.position}"
                                           placeholder="Ваша должность" id="position" readonly>
                                </div>

                                <div class="col-12 mt-4" id="formActions" style="display: none;">
                                    <button type="submit" class="btn btn-primary me-2">
                                        <i class="bi bi-check-lg me-1"></i>Сохранить изменения
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="cancelEditBtn">
                                        <i class="bi bi-x-lg me-1"></i>Отмена
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Дополнительная информация -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="stats-card h-100">
                                <h6><i class="bi bi-shield-check me-2"></i>Безопасность</h6>
                                <p class="text-muted small mb-3">Управление безопасностью учетной записи</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-warning">
                                        <i class="bi bi-key me-1"></i>Сменить пароль
                                    </button>
                                    <button class="btn btn-outline-info">
                                        <i class="bi bi-two-factor-authentication me-1"></i>2FA
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="stats-card h-100">
                                <h6><i class="bi bi-clock-history me-2"></i>Последняя активность</h6>
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <small>Текущая сессия:</small>
                                        <small class="text-success">Активна</small>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <small>Устройство:</small>
                                        <small>Chrome, Windows</small>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <small>IP-адрес:</small>
                                        <small>192.168.1.1</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Активность -->
                <div class="tab-pane fade" id="activity">
                    <div class="stats-card">
                        <h4><i class="bi bi-graph-up me-2"></i>История активности</h4>
                        <p class="text-muted">Последние действия в системе</p>

                        <div class="timeline mt-4">
                            <div class="timeline-item">
                                <div class="timeline-marker bg-success"></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Вход в систему</h6>
                                    <p class="text-muted small mb-1">Успешная аутентификация</p>
                                    <small class="text-muted">Сегодня, 14:30</small>
                                </div>
                            </div>

                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Просмотр сотрудников</h6>
                                    <p class="text-muted small mb-1">Открыт список сотрудников</p>
                                    <small class="text-muted">Сегодня, 14:25</small>
                                </div>
                            </div>

                            <div class="timeline-item">
                                <div class="timeline-marker bg-info"></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Поиск сотрудника</h6>
                                    <p class="text-muted small mb-1">Выполнен поиск по имени "Иван"</p>
                                    <small class="text-muted">Вчера, 16:45</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editBtn = document.getElementById('editProfileBtn');
        const cancelBtn = document.getElementById('cancelEditBtn');
        const formActions = document.getElementById('formActions');
        const editableFields = ['displayName', 'phoneNumber', 'department', 'position'];

        editBtn.addEventListener('click', function() {
            // Активируем редактирование полей
            editableFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.readOnly = false;
                    field.classList.add('bg-dark');
                }
            });

            // Показываем кнопки действий
            formActions.style.display = 'block';
            editBtn.style.display = 'none';
        });

        cancelBtn.addEventListener('click', function() {
            // Деактивируем редактирование
            editableFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.readOnly = true;
                    field.classList.remove('bg-dark');
                }
            });

            // Скрываем кнопки действий
            formActions.style.display = 'none';
            editBtn.style.display = 'block';
        });

        // Инициализация табов
        const triggerTabList = [].slice.call(document.querySelectorAll('a[data-bs-toggle="tab"]'));
        triggerTabList.forEach(function (triggerEl) {
            const tabTrigger = new bootstrap.Tab(triggerEl);
            triggerEl.addEventListener('click', function (event) {
                event.preventDefault();
                tabTrigger.show();
            });
        });

        // Отладочная информация в консоли
        console.log('Profile page loaded');
        console.log('Employee data:', {
            name: '[[${employee?.name}]]',
            email: '[[${employee?.email}]]',
            position: '[[${employee?.position}]]',
            department: '[[${employee?.department}]]',
            phone: '[[${employee?.phoneNumber}]]'
        });
    });
</script>
</body>
</html>